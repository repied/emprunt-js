<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Emprunt ‚Äî Mortgage Simulator</title>
    <link rel="stylesheet" href="static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <link rel="icon" type="image/x-icon" href="./static/favicon.ico">
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light' || (!savedTheme && window.matchMedia('(prefers-color-scheme: light)').matches)) {
                document.documentElement.setAttribute('data-theme', 'light');
            } else if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>

<body>
    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
        <span class="sun">‚òÄÔ∏è</span>
        <span class="moon">üåô</span>
    </button>
    <header>
        <h1>Emprunt</h1>
        <p>
            Initial savings are split between down payment and investments.<br>
            Monthly cash is split between mortgage repayments and new investment.
        </p>
    </header>

    <main>
        <section class="form">
            <form id="simulation-form">
                <div class="common-block">
                    <!-- <div class="scenario-title">Common Parameters</div> -->
                    <div class="form-grid">
                        <label>Home Cost (‚Ç¨)
                            <input name="home_cost" type="text" value="1,053,000" required>
                        </label>
                        <label>Initial savings (‚Ç¨)
                            <input name="savings" type="text" value="987,000" required>
                        </label>
                        <label>Years
                            <input name="years" type="number" value="20" required>
                        </label>
                        <label>Investments return (%)
                            <input name="investment_rate" type="number" step="0.1" value="5.0" required>
                        </label>
                        <label>Monthly cash (‚Ç¨)
                            <input name="monthly_cash" type="text" value="5,000" required>
                        </label>
                        <label>Home appreciation (%)
                            <input name="home_appreciation_rate" type="number" step="0.1" value="0.0" required>
                        </label>
                    </div>
                </div>

                <div class="dual-grid" style="margin-top: 2rem;">
                    <!-- Scenario 1 -->
                    <div class="scenario-block">
                        <div class="scenario-title">Scenario 1</div>
                        <div class="form-grid" style="grid-template-columns: 1fr;">
                            <label>Down Payment (‚Ç¨)
                                <input name="s1_down_payment" type="text" value="548,000" required>
                            </label>
                            <label>Mortgage rate (%)
                                <input name="s1_annual_rate" type="number" step="0.01" value="2.8" required>
                            </label>
                            <label>Monthly fees (‚Ç¨)
                                <input name="s1_monthly_fees" type="text" value="668" required>
                            </label>
                        </div>
                    </div>

                    <!-- Scenario 2 -->
                    <div class="scenario-block">
                        <div class="scenario-title">Scenario 2</div>
                        <div class="form-grid" style="grid-template-columns: 1fr;">
                            <label>Down Payment (‚Ç¨)
                                <input name="s2_down_payment" type="text" value="623,000" required>
                            </label>
                            <label>Mortgage rate (%)
                                <input name="s2_annual_rate" type="number" step="0.01" value="3.05" required>
                            </label>
                            <label>Monthly fees (‚Ç¨)
                                <input name="s2_monthly_fees" type="text" value="650" required>
                            </label>
                        </div>
                    </div>
                </div>
                <button type="submit" style="width: 100%; margin-top: 2rem;">Compare Scenarios</button>
            </form>
        </section>


        <div id="error-msg" class="error-msg" style="display: none;">
        </div>



        <section class="result" id="result-section" style="display: none;">
            <!-- <h2>Scenario Comparison</h2> -->

            <div class="dual-grid">
                <!-- Results Scenario 1 -->
                <div class="scenario-block">
                    <div class="scenario-title">Mortgage Principal: <span id="s1-principal-title"></span></div>

                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem; opacity: 0.8;">Monthly</h4>
                    <div class="summary-cards" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                        <div class="card" title="The amount you pay to the bank every month for the mortgage.">
                            <span class="label">Mortgage</span>
                            <span class="value" id="s1-monthly-payment"></span>
                        </div>
                        <div class="card" title="Mortgage payment plus additional monthly fees.">
                            <span class="label">Mortgage + Fees</span>
                            <span class="value" id="s1-monthly-payment-fees"></span>
                        </div>
                        <div class="card"
                            title="Money left from monthly cash after payment and fees, added to investment.">
                            <span class="label">Investment</span>
                            <span class="value" id="s1-monthly-invested"></span>
                        </div>
                    </div>

                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem; opacity: 0.8;">Final State</h4>
                    <div class="summary-cards" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                        <div class="card"
                            title="Your total net worth after the simulation: Home Value + Investment Portfolio.">
                            <span class="label">Wealth</span>
                            <span class="value" style="color: var(--success);" id="s1-final-wealth"></span>
                        </div>
                        <div class="card"
                            title="The estimated value of the home at the end of the term, including appreciation.">
                            <span class="label">Home</span>
                            <span class="value" id="s1-final-home-value"></span>
                        </div>
                        <div class="card" title="Total value of the investment portfolio at the end.">
                            <span class="label">Investments</span>
                            <span class="value" style="color: var(--success);" id="s1-final-invest-value"></span>
                        </div>
                    </div>

                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem; opacity: 0.8;">Total Flows</h4>
                    <div class="summary-cards" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                        <div class="card"
                            title="Total money you put into the deal: Initial Savings + (Monthly Cash √ó Number of Months).">
                            <span class="label">Savings + Cash</span>
                            <span class="value" id="s1-total-cash-injected"></span>
                        </div>
                        <div class="card"
                            title="The total sum of all interest payments made to the bank over the full duration of the mortgage.">
                            <span class="label">Interests paid</span>
                            <span class="value" style="color: var(--secondary);" id="s1-total-interest"></span>
                        </div>
                        <div class="card" title="Total sum of monthly fees paid over the duration.">
                            <span class="label">Fees paid</span>
                            <span class="value" style="color: var(--secondary);" id="s1-total-fees"></span>
                        </div>
                        <div class="card" title="Total gains from the investment portfolio (compounded returns).">
                            <span class="label">Investments Gain</span>
                            <span class="value" style="color: var(--success);" id="s1-total-invest-gain"></span>
                        </div>
                    </div>

                    <div id="wealth-plot-1" style="width:100%;height:350px;"></div>
                </div>

                <!-- Results Scenario 2 -->
                <div class="scenario-block">
                    <div class="scenario-title">Mortgage Principal: <span id="s2-principal-title"></span></div>

                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem; opacity: 0.8;">Monthly</h4>
                    <div class="summary-cards" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                        <div class="card" title="The amount you pay to the bank every month for the mortgage.">
                            <span class="label">Mortgage</span>
                            <span class="value" id="s2-monthly-payment"></span>
                        </div>
                        <div class="card" title="Mortgage payment plus additional monthly fees.">
                            <span class="label">Mortgage + Fees</span>
                            <span class="value" id="s2-monthly-payment-fees"></span>
                        </div>
                        <div class="card"
                            title="Money left from monthly cash after payment and fees, added to investment.">
                            <span class="label">Investment</span>
                            <span class="value" id="s2-monthly-invested"></span>
                        </div>
                    </div>

                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem; opacity: 0.8;">Final State</h4>
                    <div class="summary-cards" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                        <div class="card"
                            title="Your total net worth after the simulation: Home Value + Investment Portfolio.">
                            <span class="label">Wealth</span>
                            <span class="value" style="color: var(--success);" id="s2-final-wealth"></span>
                        </div>
                        <div class="card"
                            title="The estimated value of the home at the end of the term, including appreciation.">
                            <span class="label">Home</span>
                            <span class="value" id="s2-final-home-value"></span>
                        </div>
                        <div class="card" title="Total value of the investment portfolio at the end.">
                            <span class="label">Investments</span>
                            <span class="value" style="color: var(--success);" id="s2-final-invest-value"></span>
                        </div>
                    </div>

                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem; opacity: 0.8;">Total Flows</h4>
                    <div class="summary-cards" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                        <div class="card"
                            title="Total money you put into the deal: Initial Savings + (Monthly Cash √ó Number of Months).">
                            <span class="label">Savings + Cash</span>
                            <span class="value" id="s2-total-cash-injected"></span>
                        </div>
                        <div class="card"
                            title="The total sum of all interest payments made to the bank over the full duration of the mortgage.">
                            <span class="label">Interests paid</span>
                            <span class="value" style="color: var(--secondary);" id="s2-total-interest"></span>
                        </div>
                        <div class="card" title="Total sum of monthly fees paid over the duration.">
                            <span class="label">Fees paid</span>
                            <span class="value" style="color: var(--secondary);" id="s2-total-fees"></span>
                        </div>
                        <div class="card" title="Total gains from the investment portfolio (compounded returns).">
                            <span class="label">Investments Gain</span>
                            <span class="value" style="color: var(--success);" id="s2-total-invest-gain"></span>
                        </div>
                    </div>

                    <div id="wealth-plot-2" style="width:100%;height:350px;"></div>
                </div>
            </div>


        </section>

        <script src="static/script.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Theme Toggle Logic
                const toggle = document.getElementById('theme-toggle');
                toggle.addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';

                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);

                    // Re-render plots with new theme colors
                    if (document.getElementById('result-section').style.display !== 'none') {
                        const form = document.getElementById('simulation-form');
                        form.dispatchEvent(new Event('submit', { cancelable: true }));
                    }
                });

                const form = document.getElementById('simulation-form');
                form.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    function cleanMoney(val) {
                        if (!val) return 0.0;
                        return parseFloat(String(val).replace(/[^\d.]/g, ''));
                    }

                    try {
                        const homeCost = cleanMoney(data.home_cost);
                        const savings = cleanMoney(data.savings);
                        const years = parseInt(data.years, 10);
                        const investmentRate = parseFloat(data.investment_rate);
                        const monthlyCash = cleanMoney(data.monthly_cash);
                        const homeAppreciationRate = parseFloat(data.home_appreciation_rate);
                        const s1DownPayment = cleanMoney(data.s1_down_payment);
                        const s2DownPayment = cleanMoney(data.s2_down_payment);
                        const s1AnnualRate = parseFloat(data.s1_annual_rate);
                        const s2AnnualRate = parseFloat(data.s2_annual_rate);
                        const s1MonthlyFees = cleanMoney(data.s1_monthly_fees);
                        const s2MonthlyFees = cleanMoney(data.s2_monthly_fees);

                        const result1 = simulateMortgage(homeCost, s1DownPayment, s1AnnualRate, years, savings, investmentRate, monthlyCash, homeAppreciationRate, s1MonthlyFees);
                        const result2 = simulateMortgage(homeCost, s2DownPayment, s2AnnualRate, years, savings, investmentRate, monthlyCash, homeAppreciationRate, s2MonthlyFees);

                        document.getElementById('error-msg').style.display = 'none';
                        document.getElementById('result-section').style.display = 'block';

                        updateUI(result1, 's1');
                        updateUI(result2, 's2');

                        plotResults(result1, result2);

                    } catch (e) {
                        document.getElementById('error-msg').innerText = `Error: ${e.message}`;
                        document.getElementById('error-msg').style.display = 'block';
                        document.getElementById('result-section').style.display = 'none';
                    }
                });

                function updateUI(result, prefix) {
                    const formatCurrency = (value, unit = '‚Ç¨', divisor = 1) => {
                        const num = value / divisor;
                        return `${unit}${num.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
                    };

                    const formatK = (value) => `${formatCurrency(value, '‚Ç¨', 1000)}k`;

                    // Monthly
                    document.getElementById(`${prefix}-principal-title`).innerText = formatCurrency(result.principal);
                    document.getElementById(`${prefix}-monthly-payment`).innerText = formatCurrency(result.payment);
                    document.getElementById(`${prefix}-monthly-payment-fees`).innerText = formatCurrency(result.payment + result.monthly_fees);
                    // Monthly invested = monthly_cash - (payment + fees)
                    const monthlyInvested = result.monthly_cash - (result.payment + result.monthly_fees);
                    document.getElementById(`${prefix}-monthly-invested`).innerText = formatCurrency(monthlyInvested);

                    // Final State
                    const finalState = result.schedule[result.schedule.length - 1];
                    document.getElementById(`${prefix}-final-wealth`).innerText = formatK(finalState.combined_wealth);
                    document.getElementById(`${prefix}-final-home-value`).innerText = formatK(finalState.current_home_value);
                    document.getElementById(`${prefix}-final-invest-value`).innerText = formatK(finalState.investment_portfolio);

                    // Total Flows
                    document.getElementById(`${prefix}-total-interest`).innerText = formatK(result.total_interest);
                    document.getElementById(`${prefix}-total-fees`).innerText = formatK(result.total_fees);
                    document.getElementById(`${prefix}-total-invest-gain`).innerText = formatK(finalState.investment_gains);
                    document.getElementById(`${prefix}-total-cash-injected`).innerText = formatK(finalState.total_cash_injected);
                }

                function plotResults(result1, result2) {
                    const s1 = result1.schedule;
                    const s2 = result2.schedule;
                    const periods = s1.map(row => row.period);

                    function getThemeColors() {
                        const styles = getComputedStyle(document.documentElement);
                        return {
                            text: styles.getPropertyValue('--text').trim(),
                            muted: styles.getPropertyValue('--text-muted').trim(),
                            grid: styles.getPropertyValue('--plot-grid').trim()
                        };
                    }

                    const createIndividualPlot = (id, data, title, yMax) => {
                        const currentColors = getThemeColors();
                        const traceInvestedCash = {
                            x: periods, y: data.map(row => row.invested_cash_net),
                            name: 'Invested Cash (Net)', stackgroup: 'one',
                            line: { color: '#6366f1', width: 2 },
                            fillcolor: 'rgba(99, 102, 241, 0.4)'
                        };
                        const traceAppreciation = {
                            x: periods, y: data.map(row => row.home_appreciation),
                            name: 'Home Appreciation', stackgroup: 'one',
                            line: { color: '#f59e0b', width: 2 },
                            fillcolor: 'rgba(245, 158, 11, 0.3)'
                        };
                        const traceGains = {
                            x: periods, y: data.map(row => row.investment_gains),
                            name: 'Invest. Gains', stackgroup: 'one',
                            line: { color: '#10b981', width: 2 },
                            fillcolor: 'rgba(16, 185, 129, 0.3)'
                        };
                        const layout = {
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            plot_bgcolor: 'rgba(0,0,0,0)',
                            font: { family: 'Inter' },
                            title: { text: title, font: { size: 16, color: currentColors.text } },
                            xaxis: { title: 'Months', gridcolor: currentColors.grid, tickfont: { color: currentColors.muted } },
                            yaxis: {
                                tickprefix: '‚Ç¨',
                                exponentformat: 'SI',
                                gridcolor: currentColors.grid,
                                tickfont: { color: currentColors.muted },
                                range: [0, yMax * 1.05]
                            },
                            margin: { t: 40, b: 40, l: 60, r: 20 },
                            showlegend: true,
                            legend: { font: { size: 10, color: currentColors.text }, orientation: 'h', y: -0.3 }
                        };
                        Plotly.newPlot(id, [traceInvestedCash, traceAppreciation, traceGains], layout, { responsive: true, displayModeBar: false });
                    };

                    const maxWealth1 = s1.length > 0 ? s1[s1.length - 1].combined_wealth : 0;
                    const maxWealth2 = s2.length > 0 ? s2[s2.length - 1].combined_wealth : 0;
                    const commonYMax = Math.max(maxWealth1, maxWealth2);

                    createIndividualPlot('wealth-plot-1', s1, 'Wealth Decomposition (Scenario 1)', commonYMax);
                    createIndividualPlot('wealth-plot-2', s2, 'Wealth Decomposition (Scenario 2)', commonYMax);
                }
                // Trigger initial simulation on page load
                form.dispatchEvent(new Event('submit', { cancelable: true }));
            });
        </script>

    </main>

</body>

</html>
